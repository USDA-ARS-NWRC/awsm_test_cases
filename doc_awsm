#!/usr/bin/env python

import argparse
import os
import sys
import shutil
from subprocess import call

def run():
    parser = argparse.ArgumentParser(description='Run AWSM example cases')
    parser.add_argument('--case', metavar='C', type=str,
                        help='Test case to run, either tuol, brb, or rcew',
                        default='tuol')

    args = parser.parse_args()
    case = args.case

    # run the tuol test case
    if case == 'tuol':
        cfg = 'config_tuol_docker.ini'
        fpc = 'tuolumne'
        topo = 'tuolx_dem_50m.ipw'

    elif case == 'brb':
        cfg = 'awsm_config_0401_0630.ini'
        fpc = 'brb'
        topo = 'topo.nc'

    elif case == 'rcew':
        print('Not ready yet')
        sys.exit()

    else:
        raise IOError('Not a valid test case')

    # create maxus if needed
    if not os.path.isfile('./{}/topo/maxus.nc'.format(fpc)):
        call(('docker-compose -f {}/docker-compose.yml'
                        ' run awsm gen_maxus --window=30'
                        ' --out_maxus=/data/input/topo/maxus.nc'
                        ' /data/input/topo/{}').format(fpc, topo),
                        shell=True, universal_newlines=True)

        # rename windowed maxus as maxus
        os.remove('./{}/topo/maxus.nc'.format(fpc))
        shutil.move('./{}/topo/maxus_30window.nc'.format(fpc),
                    './{}/topo/maxus.nc'.format(fpc))

    # run system
    call(('docker-compose'
                    ' -f ./{}/docker-compose.yml'
                    ' run awsm /data/input/{}').format(fpc, cfg),
                    shell=True, universal_newlines=True)

if __name__ == '__main__':
    run()
